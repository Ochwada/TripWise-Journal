<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Upload & Create Journal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui,-apple-system,Segoe UI,Roboto; margin:2rem auto; max-width: 900px; padding:0 1rem; }
        label { font-weight:600; display:block; margin:.6rem 0 .25rem; }
        input, textarea { width:100%; padding:.6rem .7rem; border:1px solid #e5e7eb; border-radius:8px; }
        textarea { min-height: 120px; }
        button { margin-top:1rem; padding:.7rem 1rem; border:0; border-radius:9px; background:#0f62fe; color:#fff; font-weight:700; cursor:pointer; }
        pre { background:#0b1020; color:#d8e5ff; padding:1rem; border-radius:8px; overflow:auto; }
        .row { display:grid; gap:.75rem; grid-template-columns:1fr 1fr; }
    </style>
</head>
<body>
<p><a href="/static">&larr; Back</a></p>
<h1>Upload images & Create Journal</h1>

<label for="token">Bearer token</label>
<input id="token" type="text" placeholder="eyJhbGciOi..." />

<label for="files">Images / media files</label>
<input id="files" type="file" accept="image/*,video/*" multiple />

<label for="title">Title *</label>
<input id="title" type="text" placeholder="Hiking in Aberdare Forest" />

<div class="row">
    <div>
        <label for="city">City</label>
        <input id="city" type="text" placeholder="Nairobi" />
    </div>
    <div>
        <label for="country">Country</label>
        <input id="country" type="text" placeholder="Kenya" />
    </div>
</div>

<label for="description">Description</label>
<textarea id="description"></textarea>

<label for="metadata">Metadata (JSON)</label>
<textarea id="metadata" placeholder='{"mood":"excited"}'></textarea>

<button id="go">Upload & Create</button>

<h2>Response</h2>
<pre id="out"></pre>

<script>
    const JOURNAL = 'http://localhost:9094';
    const MEDIA   = 'http://localhost:9096';
    const $ = id => document.getElementById(id);
    const show = v => $('out').textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2);

    $('go').addEventListener('click', async () => {
        const token = $('token').value.trim();
        if (!token) return show('Provide a Bearer token');

        // 1) upload media
        let mediaIds = [];
        const files = $('files').files;
        if (files && files.length > 0) {
            const fd = new FormData();
            Array.from(files).forEach(f => fd.append('files', f, f.name)); // adjust field name if your API differs
            const up = await fetch(MEDIA + '/media/upload', { method:'POST', headers: { 'Authorization':'Bearer '+token }, body: fd });
            const text = await up.text(); let data; try{ data = JSON.parse(text);}catch{data = text}
            if (!up.ok) return show('Upload failed '+up.status+':\n'+text);
            mediaIds = Array.isArray(data) ? data.map(x => typeof x === 'string' ? x : x.id).filter(Boolean)
                : (data.mediaIds || []);
        }

        // 2) create journal
        const payload = {
            title: $('title').value.trim(),
            description: $('description').value.trim() || null,
            city: $('city').value.trim() || null,
            country: $('country').value.trim() || null,
            tags: [],
            metadata: parseJsonOrNull($('metadata').value),
            mediaIds
        };
        try {
            const res = await fetch(JOURNAL + '/journals', {
                method:'POST',
                headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
                body: JSON.stringify(payload)
            });
            const data = await res.text(); let parsed; try{ parsed = JSON.parse(data);}catch{parsed = data}
            show(res.ok ? parsed : ('Create failed '+res.status+':\n'+data));
        } catch (e) { show(String(e)); }
    });

    function parseJsonOrNull(raw){ if(!raw.trim()) return null; try{ return JSON.parse(raw);}catch(e){ alert('Invalid JSON: '+e.message); throw e; } }
</script>
</body>
</html>
