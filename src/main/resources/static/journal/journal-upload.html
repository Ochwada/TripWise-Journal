<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>TripWise — Upload via Presigned URL & Create Journal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --bg:#fff; --fg:#111; --muted:#6b7280; --primary:#0f62fe; --border:#e5e7eb; }
        body { font-family: system-ui,-apple-system,Segoe UI,Roboto; margin:2rem auto; max-width: 900px; padding:0 1rem; background:var(--bg); color:var(--fg); }
        h1 { margin: 0 0 1rem; }
        label { font-weight:600; display:block; margin:.8rem 0 .25rem; }
        input, textarea, select { width:100%; padding:.6rem .7rem; border:1px solid var(--border); border-radius:8px; }
        textarea { min-height: 110px; }
        button { margin-top:1rem; padding:.8rem 1rem; border:0; border-radius:9px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer; }
        button.secondary { background:#111; }
        pre { background:#0b1020; color:#d8e5ff; padding:1rem; border-radius:8px; overflow:auto; }
        .row { display:grid; gap:.75rem; grid-template-columns:1fr 1fr; }
        .hint { color:var(--muted); font-size:.9rem; }
        .chips { display:flex; gap:.5rem; flex-wrap:wrap; }
        .chip { background:#f3f4f6; border:1px solid var(--border); padding:.25rem .5rem; border-radius:999px; font-size:.85rem; }
        .grid { display:grid; gap:.75rem; grid-template-columns:1fr 1fr; }
        .ok { color:#10b981; }
        .err { color:#ef4444; }
        .muted { color: var(--muted); }
        .progress { margin-top:.5rem; height:6px; background:#eef2ff; border-radius:6px; overflow:hidden; }
        .bar { height:100%; width:0%; background:var(--primary); transition:width .2s linear; }
    </style>
</head>
<body>
<p><a href="/static" class="muted">&larr; Back</a></p>
<h1>Upload media (presigned) & Create Journal</h1>

<div class="grid">
    <div>
        <label for="mediaBase">Media Base URL</label>
        <input id="mediaBase" type="text" value="" />
        <div class="hint">Media service (init/confirm). Leave empty to use this page's origin.</div>
    </div>
    <div>
        <label for="journalBase">Journal Base URL</label>
        <input id="journalBase" type="text" value="" />
        <div class="hint">Journal service. Leave empty to use this page's origin.</div>
    </div>
</div>

<label for="token">Bearer token (Google ID token)</label>
<input id="token" type="text" placeholder="eyJhbGciOi..." />

<label for="journalId">Journal ID (for ownership + upload linkage)</label>
<input id="journalId" type="text" placeholder="existing journal id, or leave blank if creating new" />

<label for="files">Images / videos</label>
<input id="files" type="file" accept="image/*,video/*" multiple />
<div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>

<h2>New Journal (optional)</h2>
<label for="title">Title *</label>
<input id="title" type="text" placeholder="Hiking in Aberdare Forest" />

<div class="row">
    <div>
        <label for="city">City</label>
        <input id="city" type="text" placeholder="Nairobi" />
    </div>
    <div>
        <label for="country">Country</label>
        <input id="country" type="text" placeholder="Kenya" />
    </div>
</div>

<label for="description">Description</label>
<textarea id="description" placeholder="A full-day hike exploring waterfalls and wildlife."></textarea>

<label for="tags">Tags (comma-separated)</label>
<input id="tags" type="text" placeholder="hiking, nature, adventure" />

<label for="metadata">Metadata (JSON)</label>
<textarea id="metadata" placeholder='{"mood":"excited"}'></textarea>

<div class="chips"><span class="chip">Flow: init → PUT to S3/R2 → confirm → create journal</span></div>

<div class="row">
    <button id="go">Upload & Create</button>
    <button id="onlyUpload" class="secondary">Only Upload (no journal create)</button>
</div>

<h2>Response</h2>
<pre id="out" class="muted">Ready.</pre>

<script>
    const $ = id => document.getElementById(id);
    const show = v => $('out').textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2);

    // Default both base URLs to current origin (e.g., http://localhost:9094)
    (function initDefaults() {
        const origin = window.location.origin;          // e.g. http://localhost:9094
        if (!document.getElementById('journalBase').value) {
            document.getElementById('journalBase').value = origin;
        }
        if (!document.getElementById('mediaBase').value) {
            document.getElementById('mediaBase').value = 'http://localhost:9096';
        }
    })();

    const baseFor = (v) => (v && v.trim()) ? v.trim().replace(/\/+$/,'') : window.location.origin;

    function setProgress(pct) {
        $('bar').style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    function parseJsonOrNull(raw) {
        if (!raw || !raw.trim()) return null;
        try { return JSON.parse(raw); } catch (e) { alert('Invalid JSON in Metadata: ' + e.message); throw e; }
    }

    function csvToArray(raw) {
        return (raw || '')
            .split(',')
            .map(s => s.trim())
            .filter(Boolean);
    }

    async function sha256(file) {
        const buf = await file.arrayBuffer();
        const hash = await crypto.subtle.digest('SHA-256', buf);
        return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function uploadViaPresigned(token, mediaBase, journalId, file, onStep = ()=>{}) {
        const base = baseFor(mediaBase);

        // 1) INIT
        onStep('init');
        const initRes = await fetch(`${base}/media/init`, {
            method: 'POST',
            headers: {'Content-Type':'application/json','Authorization':'Bearer '+token},
            body: JSON.stringify({
                journalId,
                fileName: file.name,
                mimeType: file.type || 'application/octet-stream',
                bytes: file.size
            })
        });
        if (!initRes.ok) throw new Error('init failed ' + initRes.status);
        const init = await initRes.json(); // {mediaId, storageKey, uploadUrl, headers}

        // 2) PUT (direct to S3/R2)
        onStep('put');
        const putHeaders = new Headers(init.headers || {});
        if (!putHeaders.has('Content-Type') && file.type) putHeaders.set('Content-Type', file.type);

        await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', init.uploadUrl);
            putHeaders.forEach((v,k) => xhr.setRequestHeader(k, v));
            xhr.upload.onprogress = (evt) => {
                if (evt.lengthComputable) {
                    const pct = (evt.loaded / evt.total) * 100;
                    setProgress(pct);
                }
            };
            xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error('upload failed ' + xhr.status));
            xhr.onerror = () => reject(new Error('upload network error'));
            xhr.send(file);
        });

        // 3) CONFIRM
        onStep('confirm');
        let width = null, height = null;
        if (file.type && file.type.startsWith('image/')) {
            try {
                const bmp = await createImageBitmap(file);
                width = bmp.width; height = bmp.height;
            } catch (_) {}
        }
        const checksum = await sha256(file);

        const confRes = await fetch(`${base}/media/confirm`, {
            method: 'POST',
            headers: {'Content-Type':'application/json','Authorization':'Bearer '+token},
            body: JSON.stringify({
                mediaId: init.mediaId,
                checksum,
                bytes: file.size,
                width,
                height
            })
        });
        if (!confRes.ok) throw new Error('confirm failed ' + confRes.status);
        const media = await confRes.json(); // {id, cdnUrl, ...}
        return media.id;
    }

    async function uploadAll(token, mediaBase, journalId, files) {
        const mediaIds = [];
        let idx = 0;
        for (const f of files) {
            setProgress(0);
            const id = await uploadViaPresigned(token, mediaBase, journalId, f, (step)=>{
                const label = step.toUpperCase();
                show(`Uploading ${f.name} — step: ${label}`);
            });
            mediaIds.push(id);
            idx++;
            show({ message: `Uploaded ${idx}/${files.length}`, mediaId: id, file: f.name });
        }
        setProgress(100);
        return mediaIds;
    }

    async function createJournal(journalBase, token, payload) {
        const jb = baseFor(journalBase);
        const res = await fetch(`${jb}/journals`, {
            method:'POST',
            headers: {'Content-Type':'application/json','Authorization':'Bearer '+token},
            body: JSON.stringify(payload)
        });
        const text = await res.text(); let data;
        try { data = JSON.parse(text); } catch { data = text; }
        if (!res.ok) throw new Error('create journal failed '+res.status+': '+text);
        return data;
    }

    $('onlyUpload').addEventListener('click', async () => {
        try {
            const token = $('token').value.trim();
            const mediaBase = $('mediaBase').value.trim();
            const jId = $('journalId').value.trim();
            const files = $('files').files;
            if (!token) return show('Provide a Bearer token');
            if (!files || files.length === 0) return show('Choose at least one file');
            const ids = await uploadAll(token, mediaBase, jId || null, files);
            show({ mediaIds: ids });
        } catch (e) { show(String(e)); }
    });

    $('go').addEventListener('click', async () => {
        try {
            const token = $('token').value.trim();
            const mediaBase = $('mediaBase').value.trim();
            const journalBase = $('journalBase').value.trim();
            const files = $('files').files;
            if (!token) return show('Provide a Bearer token');
            if (!files || files.length === 0) return show('Choose at least one file');

            const jId = $('journalId').value.trim() || null;

            // 1) Upload media
            const mediaIds = await uploadAll(token, mediaBase, jId, files);

            // 2) Create journal
            const payload = {
                title: $('title').value.trim(),
                description: $('description').value.trim() || null,
                city: $('city').value.trim() || null,
                country: $('country').value.trim() || null,
                tags: csvToArray($('tags').value),
                metadata: parseJsonOrNull($('metadata').value),
                mediaIds
            };
            const resp = await createJournal(journalBase, token, payload);
            show(resp);
        } catch (e) {
            show(String(e));
        }
    });
</script>
</body>
</html>
